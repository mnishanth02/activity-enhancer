---
goal: Activity Enhancement In-Site Integration (Strava + Garmin Phase 1)
version: 1.0
date_created: 2025-10-13
last_updated: 2025-10-13
owner: activity-enhancer
tags: [content-script, dom-injection, scraping, llm, settings, architecture]
---

# Activity Enhancement Functional Integration Plan

This plan extends the popup UI implementation (`popup-impl.md`) by defining how the extension injects an "✨" Enhance button into supported activity edit pages (initially Strava & Garmin), scrapes activity metadata (title & description first), constructs a prompt using saved settings, invokes an LLM (via existing or future utility), handles responses, updates the page, and records metrics.

Focus: Keep the design lightweight, adapter-based, idempotent, and resilient to DOM churn (SPA navigation / infinite updates). Avoid premature complexity; design for incremental addition of more platforms (Nike, etc.) and more fields (stats, weather, gear) later.

---
## 1. Scope & Objectives

### In-Scope (Phase 1)

1. Detect supported host (Strava, Garmin) on activity edit/detail pages where user can modify title & description.
2. Inject a single floating / inline "✨" button near the primary activity name block (serves both title & description enhancement trigger).
3. Provide accessible tooltip: "Enhance Title and Description" (ARIA + `title` attribute fallback).
4. On click the system will:

   - Scrape current title & description.
   - Build enhancement prompt using stored settings (`tone`, `generateHashtags`, `includeWeather` (ignored if false), BYOK provider selection).
   - Call LLM (stub integration now; real provider via BYOK advanced settings if configured else default provider).
   - Expect JSON `{ "title": string, "description": string }` (each optional in response—fallback to original if missing).
   - Render an inline preview panel (Accept / Cancel). Accept updates fields in DOM; Cancel closes panel.

5. Increment metrics (monthly enhancement count) after successful Accept.
6. Persist nothing new besides metrics; all settings already stored via popup flows.

### Out of Scope (Defer)

- Authentication / Pro gating server validation.
- Streaming responses.
- Weather data enrichment (will require external API in future).
- Multi-language translation, bulk edit, advanced custom prompt editing UI.

### Success Criteria

- Button appears exactly once per supported edit page (no duplicates after navigation / dynamic loads).
- Enhancement flow completes under 3 seconds median (excluding actual LLM latency) for scraping + local logic.
- No JavaScript console errors generated by injection logic (idempotent re-runs safe).
- Title & description fields updated only after explicit Accept.

---

## 2. Functional Requirements

| ID | Requirement | Notes |
|----|-------------|-------|
| F-001 | Detect site host & route to adapter | `location.host` mapping. |
| F-002 | Provide site adapter interface for selectors & field operations | See Section 3. |
| F-003 | Inject "✨" button near top-level activity title region | Anchor placement per adapter. |
| F-004 | Tooltip "Enhance Title and Description" with accessible attributes | `aria-label`, `role="button"`, `tabIndex=0`. |
| F-005 | Keyboard activation (Enter/Space) triggers enhancement | Accessibility. |
| F-006 | Scrape current title & description text | Fallback to empty string when missing. |
| F-007 | Build prompt using user settings retrieved via storage utility | Settings schema already defined. |
| F-008 | Call LLM via utility (stub) with BYOK support | Provider resolution: advanced settings first, else default. |
| F-009 | Validate & parse JSON response | Graceful fallback if invalid. |
| F-010 | Preview panel with diff / Accept / Cancel | Minimal non-modal inline UI. |
| F-011 | Accept updates DOM inputs / textareas | Use adapter-provided setters. |
| F-012 | Cancel restores original state | Keep originals cached before modification. |
| F-013 | Increment enhancement metric on Accept | Reuse `metrics` helpers. |
| F-014 | De-duplicate button injection across mutations | Use data attribute flag. |
| F-015 | MutationObserver only processes new relevant containers | Performance requirement. |
| F-016 | Handle SPA navigation (URL change without full reload) | Poll or listen for `history.pushState` / `popstate`. |
| F-017 | Error UI: show inline error + Retry button | Don’t remove original fields. |
| F-018 | Respect domain enable toggle (from domain prefs) | Skip injection if disabled. |
| F-019 | Works with dark/light site themes (no readability regression) | Neutral styling / minimal footprint. |
| F-020 | No leakage of API key to page scripts | Run in isolated world; never attach key to DOM. |

---

## 3. Architecture & Adapter Design

### Content Script Flow

1. On load (or after SPA route change detection): determine host.
2. If host in `SUPPORTED_SITES` and domain enabled (from storage domain prefs): initialize site adapter.
3. Adapter returns config: selectors, placement strategy, field accessors.
4. Injection manager ensures a single enhancement control exists.
5. User interaction triggers enhancement pipeline (scrape → prompt → LLM → preview → apply).

### Adapter Interface (Type Sketch)

```ts
interface SiteAdapter {
  id: string; // 'strava' | 'garmin'
  match(location: Location): boolean; // host + path check
  locateTitleRoot(doc: Document): HTMLElement | null; // anchor for button
  getTitle(doc: Document): string | null;
  setTitle(doc: Document, value: string): void;
  getDescription(doc: Document): string | null;
  setDescription(doc: Document, value: string): void;
  onDomReady?(cb: () => void): void; // optional site-specific readiness hook
  mutationFilter?(node: Node): boolean; // refine observer callbacks
}
```

### Adapter Registration

- `src/entrypoints/content.ts` exports an array `siteAdapters`. Iterate `find(a => a.match(location))`.
- Each adapter isolated in `src/entrypoints/adapters/<site>.ts` (NEW directory) to keep content script clean.

### Idempotency & State Flags

- Use `data-ae-enhance-btn="1"` attribute on injected button container.
- Use `data-ae-processed="1"` on root container to avoid reprocessing heavy subtree.

---
## 4. DOM Injection Strategy

| Aspect | Approach |
|--------|----------|
| Placement | Insert button as inline element (small icon button) next to existing title input label or container. |
| Tooltip | `title` attr + visually hidden span for screen readers. |
| Styling | Minimal CSS added via content script (scoped class `.ae-enhance-btn`). Avoid global collisions. |
| Activation | Click / keydown (Enter/Space). |
| Observer | Root `document.body` observer with subtree; filter for nodes that could contain title region (adapter’s `mutationFilter`). Disconnect once button injected; re-enable on navigation change. |
| Navigation Changes | Monitor `window.location.href` changes via simple interval (500ms) or override pushState/popstate wrapper (lightweight). On change: re-run injection if domain enabled. |
| Cleanup | On navigation change: remove preview panel but leave metrics intact. |

---
## 5. Scraping Utilities

Create `src/lib/scrape.ts` (NEW): pure functions using adapter methods.

```ts
export interface ActivityData { title: string; description: string; /* future: distance, time, sport */ }

export function collectActivity(adapter: SiteAdapter, doc: Document): ActivityData {
  const title = (adapter.getTitle(doc) || "").trim();
  const description = (adapter.getDescription(doc) || "").trim();
  return { title, description };
}

export function sanitize(text: string): string {
  return text.replace(/\s+/g, " ").trim();
}
```

Future extension: structured extraction for metrics (distance, pace) if present; adapter can expose optional `getStats(): Record<string,string>`.

---
## 6. Settings Integration Mapping

| Setting | Source (Storage) | Influence |
|---------|------------------|-----------|
| tone | `sync:ae.settings.tone` | Prompt style directive. |
| generateHashtags | `sync:ae.settings.generateHashtags` | Add instruction to include relevant hashtags near end of description (limit count 3–5). |
| includeWeather (Pro) | `sync:ae.settings.includeWeather` | If true & weather data available (not implemented)—currently ignored but placeholder line in prompt clarifies absence. |
| provider / endpoint / apiKey | `sync:ae.advanced` (naming per existing utility) | Select LLM call path: default vs BYOK. |
| domain prefs | `sync:ae.domainPrefs[host]` | Gate injection & activation. |

All retrieved via existing storage helpers; add new `getAdvancedSettings()` if not present.

---
## 7. Prompt Contract

### Template (Pseudo)
```
System: You are an assistant that rewrites endurance activity titles & descriptions.
Constraints:
- Title <= 60 characters; motivational, concise; no emojis unless original had them.
- Description <= 280 characters; positive tone; never fabricate stats.
- Maintain factual data present in original text only.
- If hashtags requested, append 3-5 lowercase hashtags at end (no duplicates).

User Activity Input:
Title: "${originalTitle}"
Description: "${originalDescription || '(none)'}"
Tone: ${tone}
${generateHashtags ? 'Add hashtags.' : ''}
${includeWeather ? 'Incorporate brief weather note if given (not available now).' : ''}

Return ONLY valid JSON:
{
	"title": "...",
	"description": "..."
}
```

### Validation Steps
1. Attempt `JSON.parse`.
2. Verify object shape; if missing fields, fallback to originals.
3. Enforce max lengths (truncate gracefully at word boundary if necessary).
4. Strip trailing spaces; ensure hashtags count within bounds.

### Error Modes
| Error | Handling |
|-------|----------|
| Network/LLM timeout | Show inline panel: "Enhancement failed" + Retry. |
| Invalid JSON | Display raw response in collapsible debug view (for future) + Retry. |
| Empty response | Use original values; show warning toast (future). |

---
## 8. Enhancement Flow State Machine

States: `idle` → `collecting` → `requesting` → `preview` (`error` alternate) → `applying` → `done`.

Transitions drive small UI state object (no global store; simple local variable + minimal DOM updates).

---
## 9. Metrics & Telemetry

Reuse `metrics.ts` (add if missing function): `incrementEnhancementCount()` called on Accept.

Add lightweight error counter (future) placeholder: not persisted now—log at `console.debug` only for development.

Monthly reset logic already handled (per existing metrics helper). No additional network telemetry.

---
## 10. Performance Safeguards

| Concern | Mitigation |
|---------|------------|
| Repeated injection attempts | Idempotent data attributes; early return if button exists. |
| Excess DOM observation cost | Narrow mutation filter + disconnect after success; re-enable on navigation change only. |
| Frequent LLM calls from rapid re-clicks | Disable button while `requesting`; optional 500ms debounce. |
| Large innerHTML parsing risk | Use direct selectors; avoid querySelectorAll loops over entire document repeatedly. |
| Memory leaks | Null references & disconnect observer on unload / navigation. |

---
## 11. Security & Privacy

| Aspect | Practice |
|--------|----------|
| API Keys | Read only within content script isolated world; never written to DOM; kept in sync storage encrypted by browser. |
| Data Minimization | Send only scraped title/description and explicit settings—no hidden page metadata yet. |
| PII Risk | If description contains names, future redaction step (deferred). Document caution in README. |
| CSP / Injection | Avoid `innerHTML`; create elements; static class names. |
| Logging | No keys or entire prompt logged in production; debug only guarded by `process.env.NODE_ENV === 'development'`. |

---
## 12. Error Handling UX

| Scenario | UI Response |
|----------|-------------|
| Scrape failure (missing selectors) | Button shows tooltip: "Unsupported layout" and disables. |
| LLM failure | Inline error panel with Retry + Cancel. |
| JSON parse error | Inline error with small raw snippet preview (first 120 chars). |
| Accept apply failure (DOM changed) | Re-run adapter locate; if still absent show error & abort. |

---
## 13. Testing Strategy

### Unit
- Adapter selector resolution (mock DOM fragments) per site.
- Scrape utilities sanitize & fallback behavior.
- Prompt builder enforces constraints & includes conditional sections.
- JSON validation logic with malformed responses.

### Integration (Content Script Simulated)
- Inject button only once with multiple mutation events.
- Enhancement flow updates fields after Accept.
- Cancel leaves DOM unchanged.

### E2E (Deferred / Optional)
- Playwright script loads mock Strava HTML snapshot with injected extension build.

### Mocks
- LLM call replaced by deterministic fixture returning sample JSON.
- chrome.storage mocked via simple in-memory map.




---
## 14. Implementation Phases & Tasks

| Phase | Task ID | Description | Output |
   - Scrape current title + description.
   - Build enhancement prompt using stored settings (`tone`, `generateHashtags`, `includeWeather` (ignored if false), BYOK provider selection).
   - Call LLM (stub integration now; real provider via BYOK advanced settings if configured else default provider).
   - Expect JSON `{ title, description }` (both optional in response—use original if missing).
   - Render an inline preview panel (Accept / Cancel). Accept updates fields in DOM; Cancel closes panel.
5. Increment metrics (monthly enhancement count) after successful Accept.
6. Persist nothing new besides metrics; all settings already stored via popup flows.
| P2 | T-007 | Tooltip & accessibility attributes | Inline impl |
| P2 | T-008 | MutationObserver integration | Content script change |


- Authentication / Pro gating server validation.
- Streaming responses.
- Weather data enrichment (will require external API in future).
- Multi-language translation, bulk edit, advanced custom prompt editing UI.
| P4 | T-014 | Metrics increment hook integration | Update `metrics.ts` |
| P4 | T-015 | Error handling & retry logic | Flow update |


- Button appears exactly once per supported edit page (no duplicates after navigation / dynamic loads).
- Enhancement flow completes under 3 seconds median (excluding actual LLM latency) for scraping + local logic.
- No JavaScript console errors generated by injection logic (idempotent re-runs safe).
- Title & description fields updated only after explicit Accept.
## 15. Minimal Code Sketches (Illustrative Only)

```ts
// content.ts (excerpt)
import { siteAdapters } from "./adapters";
import { ensureInjected } from "./inject";
import { isDomainEnabled } from "@/lib/storage"; // hypothetical helper

async function init() {
	const adapter = siteAdapters.find(a => a.match(window.location));
	if (!adapter) return;
	const enabled = await isDomainEnabled(location.host);
	if (!enabled) return;
	ensureInjected(adapter, document);
	setupNavigationWatcher(() => init());
}
init();
```

```ts
// prompt.ts
export function buildPrompt(input: { title: string; description: string; settings: Settings; }): string { /* ... */ }
```

```ts
// llm.ts (stub)
export async function enhanceActivity(prompt: string, adv: AdvancedSettings) { /* provider switch */ }
```

---
## 16. Future Enhancements (Roadmap)

| Priority | Idea | Rationale |
|----------|------|-----------|
| High | Add Nike adapter | Broaden platform support. |
| High | Streaming partial suggestions | Faster perceived latency. |
| Medium | Weather auto-fetch integration | Utilize includeWeather setting. |
| Medium | Stats extraction (distance, pace) | Richer contextual prompt, better personalization. |
| Medium | Undo last enhancement | User confidence & reversibility. |
| Low | A/B variant suggestions (choose best) | Improves quality & user control. |
| Low | Personal style fine-tuning | Enhanced personalization. |

---
## 17. Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| DOM selector changes (site redesign) | Breaks scraping | Keep adapter small & fast to update; add fallback search heuristics. |
| LLM hallucination adds incorrect stats | User trust | Strict prompt instructions + optional original diff highlight (future). |
| JSON response drift | Flow break | Add regex fallback to extract JSON block. |
| Excessive observer overhead | Performance | Disconnect after injection; narrow filters. |
| API key misuse (other scripts) | Security | No DOM exposure; never message raw key. |

---
## 18. Documentation Updates

- Update root README with new “In-Site Enhancement” section (trigger, supported sites, privacy note).
- Reference this plan for adapter contributions guidelines.
- Add short CONTRIBUTING snippet for adding new adapters (interface contract + test requirements).

---
## 19. Acceptance Checklist

- [ ] Strava edit page: button appears once, tooltip present.
- [ ] Garmin edit page: same behavior.
- [ ] Disabled domain: no button injected.
- [ ] Enhancement preview shows new content; Accept updates both fields.
- [ ] Cancel leaves page unchanged.
- [ ] Metrics counter increments after Accept.
- [ ] Invalid JSON from mock LLM handled gracefully with retry UI.
- [ ] No console errors in standard flow.

---
## 20. Change Log

| Date | Version | Change |
|------|---------|--------|
| 2025-10-13 | 1.0 | Initial plan drafted. |

---
## 21. Implementation Ordering Justification

- Adapters & injection groundwork first to prove viability.
- Scrape & prompt utilities independent—unit test early.
- LLM stub isolating provider logic reduces refactor churn when adding real API.
- Metrics & error polish after core correctness proven.

---
## 22. Minimal Working Path (Fast Track)
1. Strava adapter + injection with static mock response.
2. Garmin adapter.
3. Real prompt builder + JSON parse guard.
4. Accept/Cancel preview UI.
5. Metrics increment.
6. Tests & docs.

This ensures earliest value (working button) before layering complexity.

---
## 23. Maintenance Notes

- Keep each adapter <150 LOC; if grows, split selectors & logic.
- Centralize constants (data attribute names) in one small `constants.ts` to avoid drift.
- Document any heuristic selectors with inline comments referencing site DOM fragment.

---
## 24. Open Questions (To Revisit)
| Question | Current Stance |
|----------|----------------|
| Need diff highlighting? | Defer until user feedback indicates need. |
| Multi-field (gear, weather) fetch path? | Wait for stable weather API choice. |
| Should we fallback to original if title unchanged? | Yes; still counts as enhancement only on Accept. |

---
End of Plan.
